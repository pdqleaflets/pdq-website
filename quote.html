<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDQ Leaflets - Get Quote</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #1d1d1f;
            background: #f8fafc;
        }

        /* Navigation */
        nav {
            background: white;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
            text-decoration: none;
            letter-spacing: -0.5px;
        }

        .back-link {
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #2563eb;
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .calculator-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
        }

        .calculator-header {
            margin-bottom: 40px;
        }

        .calculator-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .calculator-header p {
            color: #64748b;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Cheapest Option Button */
        .cheapest-btn {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            position: relative;
        }

        .cheapest-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .cheapest-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Special Offer Banner */
        .special-offer-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            grid-column: 1 / -1;
        }

        .special-offer-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20px;
            width: 100px;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(15deg);
        }

        .offer-content {
            flex: 1;
            z-index: 2;
        }

        .offer-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .offer-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .offer-details {
            font-size: 1.1rem;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .price-comparison {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .regular-price {
            font-size: 0.95rem;
            text-decoration: line-through;
            opacity: 0.8;
            font-weight: normal;
        }

        .savings-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .offer-includes {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }

        .offer-expiry {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 600;
        }

        .offer-cta {
            z-index: 2;
        }

        .offer-btn {
            background: white;
            color: #10b981;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .offer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            background: #f8fafc;
        }

        .offer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Form Styling */
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #374151;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 12px;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-group select {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input[type="number"] {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .area-row input[type="number"] {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .area-row input[type="number"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Input validation states */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .input-warning {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }

        /* Error messages */
        .error-message {
            margin-top: 8px;
            padding: 8px 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            color: #dc2626;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .warning-message {
            margin-top: 8px;
            padding: 8px 12px;
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            color: #92400e;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Postcode Buttons */
        .postcode-section {
            margin-bottom: 20px;
        }

        .postcode-area {
            margin-bottom: 15px;
        }

        .postcode-area h5 {
            font-size: 0.9rem;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .postcode-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .postcode-btn {
            padding: 16px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .postcode-btn:hover {
            border-color: #2563eb;
            background: #eff6ff;
            transform: translateY(-1px);
        }

        .postcode-btn.standard {
            border-left: 5px solid #10b981;
        }

        .postcode-btn.premium {
            border-left: 5px solid #f59e0b;
        }

        .postcode-btn.extended {
            border-left: 5px solid #8b5cf6;
        }

        .postcode-btn.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .area-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-standard {
            background: #10b981;
        }

        .legend-premium {
            background: #f59e0b;
        }

        .legend-extended {
            background: #8b5cf6;
        }

        .postcode-btn small {
            font-size: 0.7rem;
            font-weight: 400;
            opacity: 0.8;
        }

        .extended-area-section {
            margin-bottom: 15px;
        }

        .extended-area-section label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9rem;
            display: block;
        }

        .extended-area-section select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            width: 100%;
            background: white;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .info-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 8px;
            font-style: italic;
        }

        .area-indicator {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 12px;
            display: inline-block;
        }

        .area-standard {
            background: #dcfce7;
            color: #166534;
        }

        .area-premium {
            background: #fef3c7;
            color: #92400e;
        }

        .area-extended {
            background: #ede9fe;
            color: #6b21a8;
        }

        /* Service Options */
        .service-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .service-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .service-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .service-card h4 {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .service-card p {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .service-price {
            font-weight: 700;
            color: #2563eb;
            font-size: 1.1rem;
        }

        /* Multi-area specific styles */
        .multi-area-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .multi-area-list {
            margin-top: 20px;
        }

        .area-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr auto;
            gap: 15px;
            align-items: end;
            padding: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .area-row .form-group {
            margin: 0;
        }

        .area-row select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .area-price {
            font-weight: 600;
            color: #2563eb;
            text-align: right;
            align-self: center;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            align-self: center;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .add-area-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .add-area-btn:hover {
            background: #059669;
        }

        .multi-total {
            margin-top: 20px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 8px;
            border: 2px solid #2563eb;
        }

        .total-breakdown {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        /* Quote Summary Sidebar */
        .quote-summary {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .quote-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .quote-total {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 8px;
        }

        .quote-vat {
            color: #64748b;
            font-size: 0.9rem;
        }

        .per-leaflet {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 4px;
        }

        .quote-breakdown {
            margin: 30px 0;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .breakdown-label {
            color: #374151;
        }

        .breakdown-value {
            font-weight: 600;
            color: #1d1d1f;
        }

        .discount-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .cta-section {
            margin-top: 30px;
            text-align: center;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-block;
            width: 100%;
            margin-bottom: 16px;
            position: relative;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: #2563eb;
            padding: 12px 24px;
            border: 2px solid #2563eb;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-block;
            width: 100%;
            margin-bottom: 16px;
        }

        .btn-secondary:hover {
            background: #2563eb;
            color: white;
        }

        .save-quote-btn {
            background: #64748b;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            width: 100%;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .save-quote-btn:hover {
            background: #475569;
        }

        .guarantee-text {
            margin-top: 20px;
            font-size: 0.85rem;
            color: #64748b;
            text-align: center;
            padding: 16px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .validation-warning {
            margin-top: 15px;
            padding: 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-weight: 500;
            display: none;
        }

        .duplicate-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }

        /* Success states */
        .success-message {
            margin-top: 15px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            color: #166534;
            font-weight: 500;
        }

        /* Quote saved notification */
        .quote-saved-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .quote-saved-popup.show {
            transform: translateX(0);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .special-offer-banner {
                grid-column: 1;
            }

            .quote-summary {
                position: static;
                top: auto;
                order: 1;
            }
            
            .calculator-section {
                order: 0;
            }
        }

        @media (max-width: 768px) {
            .special-offer-banner {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .offer-title {
                font-size: 1.2rem;
            }

            .offer-details {
                font-size: 1rem;
            }

            .price-comparison {
                justify-content: center;
                font-size: 0.9rem;
            }
            .main-container {
                padding: 20px 15px;
            }

            .calculator-section {
                padding: 30px 20px;
            }

            .calculator-header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .quote-total {
                font-size: 2rem;
            }

            .postcode-buttons {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .postcode-btn {
                padding: 12px 8px;
                font-size: 0.85rem;
            }

            .postcode-btn small {
                font-size: 0.6rem;
            }

            .service-options {
                grid-template-columns: 1fr;
            }

            .area-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .area-price {
                text-align: left;
            }

            .area-legend {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .postcode-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-container {
                padding: 0 15px;
            }
            
            .logo {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">PDQ LEAFLETS</a>
            <a href="index.html" class="back-link">
                ‚Üê Back to Home
            </a>
        </div>
    </nav>

    <!-- Quote Saved Popup -->
    <div id="quote-saved-popup" class="quote-saved-popup">
        ‚úÖ Quote saved to clipboard!
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Special Offer Banner -->
        <div class="special-offer-banner">
            <div class="offer-content">
                <div class="offer-badge">üéâ LAUNCH SPECIAL</div>
                <div class="offer-title">Design + Print + Distribute Package</div>
                <div class="offer-details">
                    <strong>5,000 Double-Sided A5 Flyers for just ¬£200 + VAT</strong>
                    <div class="price-comparison">
                        <span class="regular-price">Regular Price: ¬£438 + VAT</span>
                        <span class="savings-badge">SAVE ¬£238 (54%)</span>
                    </div>
                    <span class="offer-includes">Includes: Professional design, premium printing & full distribution</span>
                </div>
                <div class="offer-expiry">‚è∞ Offer ends 1st September 2025 (Subject to availability)</div>
            </div>
            <div class="offer-cta">
                <button class="offer-btn" onclick="applySpecialOffer()">
                    ‚ö° Apply This Offer
                </button>
            </div>
        </div>

        <!-- Calculator Form -->
        <div class="calculator-section">
            <div class="calculator-header">
                <h1>Get Your Instant Quote</h1>
                <p><b>EXPERIMENTAL FEATURE - Pricing is NOT guaranteed. This tool is under construction. Please call us for a quote 01752 546 123.</b></p>
                <p>Configure your leaflet campaign below to see real-time pricing for distribution, design, and printing services.</p>
            </div>

            <!-- Distribution Settings -->
            <div class="form-section">
                <h3 class="section-title">üìç Distribution Details</h3>
                
                <div class="multi-area-toggle">
                    <input type="checkbox" id="multi-area-mode">
                    <label for="multi-area-mode" style="margin: 0; font-weight: 600;">Split delivery across multiple areas</label>
                </div>
                
                <div id="single-area-section">
                    <div class="postcode-section">
                        <label style="font-weight: 600; margin-bottom: 12px; color: #374151; font-size: 0.95rem; display: block;">Delivery Area</label>
                        
                        <div class="postcode-area">
                            <h5>Main Areas</h5>
                            <div class="postcode-buttons">
                                <button class="postcode-btn premium" onclick="setPostcode('PL1')">PL1</button>
                                <button class="postcode-btn standard" onclick="setPostcode('PL2')">PL2</button>
                                <button class="postcode-btn premium" onclick="setPostcode('PL3')">PL3</button>
                                <button class="postcode-btn premium" onclick="setPostcode('PL4')">PL4</button>
                                <button class="postcode-btn standard" onclick="setPostcode('PL5')">PL5</button>
                                <button class="postcode-btn standard" onclick="setPostcode('PL6')">PL6</button>
                                <button class="postcode-btn standard" onclick="setPostcode('PL7')">PL7</button>
                                <button class="postcode-btn premium" onclick="setPostcode('PL8')">PL8</button>
                                <button class="postcode-btn standard" onclick="setPostcode('PL9')">PL9</button>
                            </div>
                            
                            <!-- Cheapest Option Button -->
                            <div style="margin-top: 15px; text-align: center;">
                                <button class="cheapest-btn" onclick="setCheapestOption()">
                                    üí∞ Pick Standard Area - Cheapest Option
                                </button>
                            </div>
                        </div>
                        
                        <div class="extended-area-section">
                            <label for="extended-areas">Extended Areas</label>
                            <select id="extended-areas">
                                <option value="">Select extended area...</option>
                                <optgroup label="Standard Extended Areas (+¬£8/1k)">
                                    <option value="PL12">PL12 - Saltash (+¬£8 per 1,000)</option>
                                    <option value="PL21">PL21 - Ivybridge (+¬£8 per 1,000)</option>
                                    <option value="TQ7">TQ7 - Kingsbridge (+¬£8 per 1,000)</option>
                                    <option value="TQ9">TQ9 - Dartmouth (+¬£8 per 1,000)</option>
                                </optgroup>
                                <optgroup label="Premium Extended Areas (+¬£8/1k)">
                                    <option value="PL13">PL13 - Looe (+¬£8 per 1,000)</option>
                                    <option value="PL14">PL14 - Liskeard (+¬£8 per 1,000)</option>
                                    <option value="PL15">PL15 - Launceston (+¬£8 per 1,000)</option>
                                    <option value="PL19">PL19 - Tavistock (+¬£8 per 1,000)</option>
                                    <option value="PL20">PL20 - Yelverton (+¬£8 per 1,000)</option>
                                    <option value="TQ1">TQ1 - Torquay (+¬£8 per 1,000)</option>
                                    <option value="TQ2">TQ2 - Babbacombe (+¬£8 per 1,000)</option>
                                    <option value="TQ3">TQ3 - Paignton (+¬£8 per 1,000)</option>
                                    <option value="TQ8">TQ8 - Salcombe (+¬£8 per 1,000)</option>
                                </optgroup>
                            </select>
                            <div class="info-text">Extended areas include an additional ¬£8 charge per 1,000 leaflets</div>
                        </div>
                        
                        <div class="area-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-standard"></div>
                                <span>Standard Areas</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-premium"></div>
                                <span>Premium Areas</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-extended"></div>
                                <span>Extended Areas (+¬£8)</span>
                            </div>
                        </div>
                        <div id="area-indicator"></div>
                    </div>

                    <div class="form-grid" style="margin-top: 30px;">
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" min="1000" step="1000" placeholder="Enter quantity (min 1,000)" value="1000">
                            <div class="info-text">Higher quantities = better per-leaflet pricing</div>
                            <div id="quantity-error" class="error-message" style="display: none;">
                                Minimum order is 1,000 leaflets
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="delivery-type">Delivery Type</label>
                            <select id="delivery-type">
                                <option value="standard">Standard Delivery</option>
                                <option value="solus">Solus Delivery (Exclusive)</option>
                            </select>
                            <div class="info-text">Solus = your leaflets delivered alone (premium service)</div>
                        </div>
                    </div>
                </div>

                <div id="multi-area-section" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 0.95rem; display: block;">Delivery Type (applies to all areas)</label>
                        <select id="multi-delivery-type">
                            <option value="standard">Standard Delivery</option>
                            <option value="solus">Solus Delivery (Exclusive)</option>
                        </select>
                    </div>
                    
                    <div class="multi-area-list" id="multi-area-list">
                        <!-- Areas will be added here dynamically -->
                    </div>
                    
                    <button class="add-area-btn" onclick="addArea()">+ Add Area</button>
                    
                    <div id="duplicate-area-warning" class="validation-warning duplicate-warning" style="display: none;">
                        ‚ö†Ô∏è This area is already selected. Please choose a different area.
                    </div>
                    
                    <div id="multi-area-total" class="multi-total" style="display: none;">
                        <div class="total-breakdown">
                            <span>Total Leaflets:</span>
                            <span id="total-leaflets">0</span>
                        </div>
                        <div class="total-breakdown">
                            <span>Distribution Total:</span>
                            <span id="multi-distribution-total">¬£0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Design Services -->
            <div class="form-section">
                <h3 class="section-title">üé® Design Services (Optional)</h3>
                <div class="service-options">
                    <div class="service-card selected" id="design-none" onclick="selectDesign('none')">
                        <h4>No Design Needed</h4>
                        <p>I already have my design ready</p>
                        <div class="service-price">¬£0</div>
                    </div>
                    <div class="service-card" id="design-single" onclick="selectDesign('single')">
                        <h4>Single-Sided Design</h4>
                        <p>Professional design (one side)</p>
                        <div class="service-price">¬£50</div>
                    </div>
                    <div class="service-card" id="design-double" onclick="selectDesign('double')">
                        <h4>Double-Sided Design</h4>
                        <p>Professional design (both sides)</p>
                        <div class="service-price">¬£75</div>
                    </div>
                    <div class="service-card" id="design-bifold" onclick="selectDesign('bifold')">
                        <h4>Bi-Fold Design</h4>
                        <p>4-panel folded leaflet design</p>
                        <div class="service-price">¬£90</div>
                    </div>
                </div>
                
                <div class="checkbox-group" id="source-files-option" style="display: none; margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <input type="checkbox" id="source-files">
                    <label for="source-files"><strong>Add source files (+¬£25)</strong> - Get editable design files</label>
                </div>
            </div>

            <!-- Printing Services -->
            <div class="form-section">
                <h3 class="section-title">üñ®Ô∏è Printing Services (Optional)</h3>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="include-printing">
                    <label for="include-printing">Include professional printing</label>
                </div>
                <div class="info-text">We only offer printing for leaflets we distribute</div>

                <div id="printing-options" style="margin-top: 20px; display: none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="paper-size">Paper Size</label>
                            <select id="paper-size">
                                <option value="">Select size...</option>
                                <option value="A6">A6 (105 √ó 148mm) - Compact</option>
                                <option value="A5">A5 (148 √ó 210mm) - Popular</option>
                                <option value="A4">A4 (210 √ó 297mm) - Large</option>
                                <option value="DL">DL (99 √ó 210mm) - Slim</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="paper-stock">Paper Quality</label>
                            <select id="paper-stock">
                                <option value="">Select quality...</option>
                                <option value="budget">Budget (130gsm) - Cost-effective</option>
                                <option value="standard">Standard (170gsm) - Popular choice</option>
                                <option value="premium">Premium (250gsm) - High quality</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="paper-finish">Paper Finish</label>
                            <select id="paper-finish">
                                <option value="">Select finish...</option>
                                <option value="matte">Matte - Professional look</option>
                                <option value="gloss">Gloss - Vibrant colors</option>
                                <option value="uncoated">Uncoated - Natural feel</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="print-sides">Print Sides</label>
                            <select id="print-sides">
                                <option value="">Select sides...</option>
                                <option value="single">Single Sided</option>
                                <option value="double">Double Sided</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="printing-incomplete" class="warning-message" style="display: none;">
                        ‚ö†Ô∏è Please complete all printing options to see accurate pricing
                    </div>
                    
                    <div id="design-print-mismatch" class="validation-warning" style="display: none;">
                        ‚ö†Ô∏è You've selected double-sided design but single-sided printing. Consider choosing double-sided printing to use your full design.
                    </div>
                </div>
            </div>

            <!-- Discounts -->
            <div class="form-section">
                <h3 class="section-title">üí∞ Available Discounts</h3>
                <div class="info-text" style="margin-bottom: 15px;">Discounts apply to distribution costs only</div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="new-customer">
                    <label for="new-customer">New customer discount (-15%)</label>
                </div>
                <div class="info-text">First-time customers receive 15% off distribution</div>
                
                <div class="checkbox-group" style="margin-top: 15px;">
                    <input type="checkbox" id="annual-contract">
                    <label for="annual-contract">Annual contract discount (-12%)</label>
                </div>
                <div class="info-text">Annual contract requires minimum 5k leaflets/month commitment</div>
                
                <div id="combined-discount-info" class="success-message" style="display: none; margin-top: 15px;">
                    üéâ Combined discount: Save 25% on distribution costs!
                </div>
            </div>
        </div>

        <!-- Quote Summary -->
        <div class="quote-summary">
            <div class="quote-header">
                <div class="quote-total" id="quote-total">¬£58.00</div>
                <div class="quote-vat" id="quote-vat">¬£69.60 inc. VAT</div>
                <div class="per-leaflet" id="per-leaflet">¬£0.058 per leaflet</div>
            </div>

            <div class="quote-breakdown">
                <div class="breakdown-item">
                    <span class="breakdown-label">Distribution</span>
                    <span class="breakdown-value" id="distribution-cost">¬£58.00</span>
                </div>
                <div class="breakdown-item" id="design-breakdown" style="display: none;">
                    <span class="breakdown-label">Design</span>
                    <span class="breakdown-value" id="design-cost">¬£0.00</span>
                </div>
                <div class="breakdown-item" id="printing-breakdown" style="display: none;">
                    <span class="breakdown-label">Printing</span>
                    <span class="breakdown-value" id="printing-cost">¬£0.00</span>
                </div>
                <div class="breakdown-item" id="discount-breakdown" style="display: none;">
                    <span class="breakdown-label">Discount <span class="discount-badge" id="discount-badge"></span></span>
                    <span class="breakdown-value" id="discount-amount">-¬£0.00</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Total (ex. VAT)</span>
                    <span class="breakdown-value" id="total-ex-vat">¬£58.00</span>
                </div>
            </div>

            <div class="cta-section">
                <button class="btn-primary" onclick="requestQuote()" id="request-quote-btn">
                    Request To Book
                </button>
                <button class="save-quote-btn" onclick="saveQuote()">
                    üìã Save Quote
                </button>
                <a href="tel:01752546123" class="btn-secondary">
                    üìû Call: 01752 546 123
                </a>
            </div>

            <div class="guarantee-text">
                üõ°Ô∏è <strong>100% Money-Back Guarantee</strong><br>
                We'll provide full delivery tracking, or your money back.
            </div>
        </div>
    </div>

    <script>
        // Enhanced state management and bug fixes
        class QuoteCalculator {
            constructor() {
                this.isCalculating = false;
                this.debounceTimer = null;
                this.currentDesign = 'none';
                this.selectedArea = 'PL2';
                this.isMultiArea = false;
                this.multiAreas = [];
                this.eventListeners = new Map();
                this.isSpecialOffer = false; // Track if special offer is applied
                this.isApplyingSpecialOffer = false; // Track if we're in the middle of applying special offer
                
                // Pricing data with improved structure
                this.pricingData = {
                    standard: {
                        standard: { '1-4k': 58, '5-9k': 55, '10-24k': 51, '25-49k': 47, '50k+': 44 },
                        solus: { '1-4k': 130, '5-9k': 125, '10-24k': 118, '25-49k': 112, '50k+': 108 }
                    },
                    premium: {
                        standard: { '1-4k': 85, '5-9k': 80, '10-24k': 75, '25-49k': 70, '50k+': 65 },
                        solus: { '1-4k': 185, '5-9k': 178, '10-24k': 170, '25-49k': 162, '50k+': 155 }
                    }
                };

                // Improved printing prices with better scaling
                this.printingPrices = {
                    A6: { budget: { 1000: 15, 2000: 25, 5000: 45, 10000: 75, 25000: 150, 50000: 280 },
                          standard: { 1000: 20, 2000: 32, 5000: 58, 10000: 95, 25000: 190, 50000: 350 },
                          premium: { 1000: 28, 2000: 45, 5000: 78, 10000: 125, 25000: 250, 50000: 450 } },
                    A5: { budget: { 1000: 18, 2000: 30, 5000: 52, 10000: 85, 25000: 170, 50000: 320 },
                          standard: { 1000: 25, 2000: 40, 5000: 68, 10000: 110, 25000: 220, 50000: 400 },
                          premium: { 1000: 35, 2000: 55, 5000: 92, 10000: 150, 25000: 300, 50000: 550 } },
                    A4: { budget: { 1000: 25, 2000: 42, 5000: 72, 10000: 115, 25000: 230, 50000: 420 },
                          standard: { 1000: 35, 2000: 58, 5000: 95, 10000: 155, 25000: 310, 50000: 560 },
                          premium: { 1000: 48, 2000: 78, 5000: 125, 10000: 200, 25000: 400, 50000: 720 } },
                    DL: { budget: { 1000: 16, 2000: 28, 5000: 48, 10000: 78, 25000: 155, 50000: 290 },
                          standard: { 1000: 22, 2000: 36, 5000: 62, 10000: 100, 25000: 200, 50000: 380 },
                          premium: { 1000: 32, 2000: 50, 5000: 85, 10000: 135, 25000: 270, 50000: 500 } }
                };

                this.standardAreas = ['PL2', 'PL5', 'PL6', 'PL7', 'PL9'];
                this.premiumAreas = ['PL1', 'PL3', 'PL4', 'PL8'];
                this.extendedStandard = ['PL12', 'PL21', 'TQ7', 'TQ9'];
                this.extendedPremium = ['PL13', 'PL14', 'PL15', 'PL19', 'PL20', 'TQ1', 'TQ2', 'TQ3', 'TQ8'];

                this.init();
            }

            init() {
                this.initializeEventListeners();
                this.setInitialState();
                this.calculatePrice();
                console.log('Enhanced PDQ Calculator initialized successfully');
            }

            // Improved quantity validation with better error handling
            validateQuantity(value, showError = true) {
                const num = parseInt(value) || 0;
                const errorElement = showError ? document.getElementById('quantity-error') : null;
                
                if (num < 1000) {
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        errorElement.closest('.form-group').querySelector('input').classList.add('input-error');
                    }
                    return 1000;
                } else {
                    if (errorElement) {
                        errorElement.style.display = 'none';
                        errorElement.closest('.form-group').querySelector('input').classList.remove('input-error');
                    }
                }
                
                return Math.ceil(num / 1000) * 1000;
            }

            getAreaType(areaCode) {
                if (this.standardAreas.includes(areaCode)) return 'standard';
                if (this.premiumAreas.includes(areaCode)) return 'premium';
                if (this.extendedStandard.includes(areaCode)) return 'standard-extended';
                if (this.extendedPremium.includes(areaCode)) return 'premium-extended';
                return null;
            }

            getQuantityTier(quantity) {
                if (quantity >= 50000) return '50k+';
                if (quantity >= 25000) return '25-49k';
                if (quantity >= 10000) return '10-24k';
                if (quantity >= 5000) return '5-9k';
                return '1-4k';
            }

            // Improved printing price calculation with better scaling
            getPrintingPrice(quantity, size, stock, doubleSided) {
                if (!size || !stock) return 0;
                
                const quantities = [1000, 2000, 5000, 10000, 25000, 50000];
                let closestQty = quantities.reduce((prev, curr) => 
                    Math.abs(curr - quantity) < Math.abs(prev - quantity) ? curr : prev
                );
                
                let basePrice = this.printingPrices[size]?.[stock]?.[closestQty] || 0;
                
                // Improved scaling with more consistent pricing
                if (quantity !== closestQty && basePrice > 0) {
                    const ratio = quantity / closestQty;
                    // Use more conservative scaling for better pricing consistency
                    const scalingFactor = ratio > 1 ? Math.pow(ratio, 0.75) : Math.pow(ratio, 0.9);
                    basePrice = basePrice * scalingFactor;
                }
                
                if (doubleSided) {
                    basePrice *= 1.3;
                }
                
                return Math.round(basePrice);
            }

            // Enhanced duplicate area checking
            checkDuplicateAreas(newAreaCode, excludeId = null) {
                const duplicateExists = this.multiAreas.some(area => 
                    area.area === newAreaCode && area.id !== excludeId
                );
                
                const warningElement = document.getElementById('duplicate-area-warning');
                if (duplicateExists && newAreaCode) {
                    warningElement.style.display = 'block';
                    return true;
                } else {
                    warningElement.style.display = 'none';
                    return false;
                }
            }

            // Enhanced design/print mismatch checking
            checkDesignPrintMismatch() {
                const designPrintMismatch = document.getElementById('design-print-mismatch');
                const includePrinting = document.getElementById('include-printing').checked;
                const printSides = document.getElementById('print-sides').value;
                
                if (includePrinting && this.currentDesign === 'double' && printSides === 'single') {
                    designPrintMismatch.style.display = 'block';
                } else {
                    designPrintMismatch.style.display = 'none';
                }
            }

            // Enhanced combined discount display
            updateCombinedDiscountDisplay() {
                const newCustomer = document.getElementById('new-customer').checked;
                const annualContract = document.getElementById('annual-contract').checked;
                const combinedInfo = document.getElementById('combined-discount-info');
                
                if (newCustomer && annualContract) {
                    combinedInfo.style.display = 'block';
                } else {
                    combinedInfo.style.display = 'none';
                }
            }

            // Improved debounced calculation
            debouncedCalculate() {
                // Don't reset special offer if we're in the middle of applying it
                if (!this.isApplyingSpecialOffer) {
                    this.resetSpecialOffer();
                }
                
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }
                
                this.debounceTimer = setTimeout(() => {
                    this.calculatePrice();
                }, 150);
            }

            setPostcode(areaCode) {
                this.selectedArea = areaCode;
                
                document.querySelectorAll('.postcode-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                document.getElementById('extended-areas').value = '';
                event.target.classList.add('selected');
                
                this.debouncedCalculate();
            }

            setExtendedArea() {
                const dropdown = document.getElementById('extended-areas');
                if (dropdown.value) {
                    this.selectedArea = dropdown.value;
                    
                    document.querySelectorAll('.postcode-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    this.debouncedCalculate();
                }
            }

            selectDesign(type) {
                this.currentDesign = type;
                
                document.querySelectorAll('#design-none, #design-single, #design-double, #design-bifold').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('design-' + type).classList.add('selected');
                
                const sourceFilesOption = document.getElementById('source-files-option');
                if (type !== 'none') {
                    sourceFilesOption.style.display = 'flex';
                } else {
                    sourceFilesOption.style.display = 'none';
                    document.getElementById('source-files').checked = false;
                }
                
                this.checkDesignPrintMismatch();
                this.debouncedCalculate();
            }

            // Updated "Best Value" calculation that randomly picks a standard area
            setCheapestOption() {
                // Pick a random standard area (they all have the same price)
                const randomIndex = Math.floor(Math.random() * this.standardAreas.length);
                const randomStandardArea = this.standardAreas[randomIndex];
                
                this.selectedArea = randomStandardArea;
                
                // Update form values with defaults
                document.getElementById('quantity').value = 1000;
                document.getElementById('delivery-type').value = 'standard';
                
                // Update postcode selections
                document.querySelectorAll('.postcode-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector(`[onclick="setPostcode('${randomStandardArea}')"]`).classList.add('selected');
                
                document.getElementById('extended-areas').value = '';
                
                this.selectDesign('none');
                
                document.getElementById('include-printing').checked = false;
                this.togglePrintingOptions();
                
                // Apply new customer discount for best price
                document.getElementById('new-customer').checked = true;
                document.getElementById('annual-contract').checked = false;
                
                document.getElementById('multi-area-mode').checked = false;
                this.toggleMultiArea();
                
                // Show loading state
                const btn = document.querySelector('.cheapest-btn');
                btn.classList.add('loading');
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    this.calculatePrice();
                }, 500);
            }

            // Apply Special Offer function
            applySpecialOffer() {
                // Set flag to prevent resetSpecialOffer during application
                this.isApplyingSpecialOffer = true;
                this.isSpecialOffer = true;
                
                // Set the special offer configuration
                document.getElementById('quantity').value = 5000;
                document.getElementById('delivery-type').value = 'standard';
                
                // Pick a random standard area for best price
                const randomIndex = Math.floor(Math.random() * this.standardAreas.length);
                const randomStandardArea = this.standardAreas[randomIndex];
                this.selectedArea = randomStandardArea;
                
                // Update postcode selections
                document.querySelectorAll('.postcode-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector(`[onclick="setPostcode('${randomStandardArea}')"]`).classList.add('selected');
                
                document.getElementById('extended-areas').value = '';
                
                // Set design service
                this.selectDesign('double');
                
                // Set printing options
                document.getElementById('include-printing').checked = true;
                this.togglePrintingOptions();
                document.getElementById('paper-size').value = 'A5';
                document.getElementById('paper-stock').value = 'standard';
                document.getElementById('paper-finish').value = 'matte';
                document.getElementById('print-sides').value = 'double';
                
                // Clear discounts for the special offer
                document.getElementById('new-customer').checked = false;
                document.getElementById('annual-contract').checked = false;
                
                // Ensure single area mode
                document.getElementById('multi-area-mode').checked = false;
                this.toggleMultiArea();
                
                // Show loading state on the offer button
                const btn = document.querySelector('.offer-btn');
                btn.classList.add('loading');
                btn.disabled = true;
                btn.textContent = '‚ö° Applying Offer...';
                
                setTimeout(() => {
                    // Clear the applying flag and calculate
                    this.isApplyingSpecialOffer = false;
                    
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ Offer Applied!';
                    btn.style.background = '#10b981';
                    btn.style.color = 'white';
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        btn.textContent = '‚ö° Apply This Offer';
                        btn.style.background = 'white';
                        btn.style.color = '#10b981';
                    }, 3000);
                    
                    // Force immediate calculation
                    this.calculatePrice();
                }, 800);
            }

            // Reset special offer flag when form changes
            resetSpecialOffer() {
                if (this.isSpecialOffer) {
                    // Check if current settings still match the special offer
                    const quantity = this.validateQuantity(document.getElementById('quantity').value, false);
                    const isStillSpecialOffer = quantity === 5000 && 
                        this.currentDesign === 'double' && 
                        document.getElementById('include-printing').checked && 
                        document.getElementById('paper-size').value === 'A5' &&
                        document.getElementById('print-sides').value === 'double';
                    
                    if (!isStillSpecialOffer) {
                        this.isSpecialOffer = false;
                    }
                }
            }

            togglePrintingOptions() {
                const checkbox = document.getElementById('include-printing');
                const options = document.getElementById('printing-options');
                options.style.display = checkbox.checked ? 'block' : 'none';
                
                if (!checkbox.checked) {
                    document.getElementById('paper-size').value = '';
                    document.getElementById('paper-stock').value = '';
                    document.getElementById('paper-finish').value = '';
                    document.getElementById('print-sides').value = '';
                }
                
                this.checkDesignPrintMismatch();
                this.debouncedCalculate();
            }

            isPrintingComplete() {
                if (!document.getElementById('include-printing').checked) return true;
                
                return document.getElementById('paper-size').value !== '' &&
                       document.getElementById('paper-stock').value !== '' &&
                       document.getElementById('paper-finish').value !== '' &&
                       document.getElementById('print-sides').value !== '';
            }

            toggleMultiArea() {
                this.isMultiArea = document.getElementById('multi-area-mode').checked;
                
                const singleSection = document.getElementById('single-area-section');
                const multiSection = document.getElementById('multi-area-section');
                
                if (this.isMultiArea) {
                    singleSection.style.display = 'none';
                    multiSection.style.display = 'block';
                    
                    if (this.multiAreas.length === 0) {
                        this.addArea();
                    }
                } else {
                    singleSection.style.display = 'block';
                    multiSection.style.display = 'none';
                    
                    // Clean up multi-area data
                    this.multiAreas = [];
                    document.getElementById('multi-area-list').innerHTML = '';
                    document.getElementById('duplicate-area-warning').style.display = 'none';
                    
                    this.debouncedCalculate();
                }
            }

            createAreaOptions() {
                const mainAreas = [
                    { code: 'PL1', name: 'PL1', type: 'premium' },
                    { code: 'PL2', name: 'PL2', type: 'standard' },
                    { code: 'PL3', name: 'PL3', type: 'premium' },
                    { code: 'PL4', name: 'PL4', type: 'premium' },
                    { code: 'PL5', name: 'PL5', type: 'standard' },
                    { code: 'PL6', name: 'PL6', type: 'standard' },
                    { code: 'PL7', name: 'PL7', type: 'standard' },
                    { code: 'PL8', name: 'PL8', type: 'premium' },
                    { code: 'PL9', name: 'PL9', type: 'standard' }
                ];
                
                const extendedAreas = [
                    { code: 'PL12', name: 'PL12 - Saltash (+¬£8/1k)', type: 'standard-extended' },
                    { code: 'PL21', name: 'PL21 - Ivybridge (+¬£8/1k)', type: 'standard-extended' },
                    { code: 'TQ7', name: 'TQ7 - Kingsbridge (+¬£8/1k)', type: 'standard-extended' },
                    { code: 'TQ9', name: 'TQ9 - Dartmouth (+¬£8/1k)', type: 'standard-extended' },
                    { code: 'PL13', name: 'PL13 - Looe (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'PL14', name: 'PL14 - Liskeard (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'PL15', name: 'PL15 - Launceston (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'PL19', name: 'PL19 - Tavistock (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'PL20', name: 'PL20 - Yelverton (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'TQ1', name: 'TQ1 - Torquay (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'TQ2', name: 'TQ2 - Babbacombe (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'TQ3', name: 'TQ3 - Paignton (+¬£8/1k)', type: 'premium-extended' },
                    { code: 'TQ8', name: 'TQ8 - Salcombe (+¬£8/1k)', type: 'premium-extended' }
                ];
                
                let options = '<option value="">Select area...</option>';
                
                options += '<optgroup label="Main Areas">';
                mainAreas.forEach(area => {
                    options += `<option value="${area.code}">${area.name}</option>`;
                });
                options += '</optgroup>';
                
                options += '<optgroup label="Extended Areas (+¬£8/1k)">';
                extendedAreas.forEach(area => {
                    options += `<option value="${area.code}">${area.name}</option>`;
                });
                options += '</optgroup>';
                
                return options;
            }

            addArea() {
                const areaId = 'area_' + Date.now();
                const areaRow = document.createElement('div');
                areaRow.className = 'area-row';
                areaRow.id = areaId;
                
                areaRow.innerHTML = `
                    <div class="form-group">
                        <label>Area</label>
                        <select onchange="calculator.updateMultiArea('${areaId}')">
                            ${this.createAreaOptions()}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" min="1000" step="1000" placeholder="Enter quantity (min 1,000)" value="1000" onchange="calculator.updateMultiArea('${areaId}')" onblur="calculator.updateMultiArea('${areaId}')">
                    </div>
                    <div class="area-price" id="price_${areaId}">
                        ¬£0.00
                    </div>
                    <div>
                        <button class="remove-btn" onclick="calculator.removeArea('${areaId}')">Remove</button>
                    </div>
                `;
                
                document.getElementById('multi-area-list').appendChild(areaRow);
                
                this.multiAreas.push({
                    id: areaId,
                    area: '',
                    quantity: 1000,
                    price: 0
                });
            }

            removeArea(areaId) {
                const element = document.getElementById(areaId);
                if (element) {
                    element.remove();
                }
                this.multiAreas = this.multiAreas.filter(area => area.id !== areaId);
                
                document.getElementById('duplicate-area-warning').style.display = 'none';
                this.updateMultiAreaTotal();
            }

            updateMultiArea(areaId) {
                const row = document.getElementById(areaId);
                if (!row) return;
                
                const selects = row.querySelectorAll('select');
                const inputs = row.querySelectorAll('input[type="number"]');
                const area = selects[0].value;
                
                if (area && this.checkDuplicateAreas(area, areaId)) {
                    selects[0].value = '';
                    return;
                }
                
                const inputValue = inputs[0].value;
                const quantity = this.validateQuantity(inputValue, false);
                inputs[0].value = quantity;
                
                const areaIndex = this.multiAreas.findIndex(a => a.id === areaId);
                if (areaIndex !== -1) {
                    this.multiAreas[areaIndex].area = area;
                    this.multiAreas[areaIndex].quantity = quantity;
                    
                    if (area && quantity > 0) {
                        const deliveryType = document.getElementById('multi-delivery-type').value;
                        const areaType = this.getAreaType(area);
                        const isExtended = areaType && areaType.includes('extended');
                        const baseAreaType = areaType ? areaType.replace('-extended', '') : 'standard';
                        const quantityTier = this.getQuantityTier(quantity);
                        
                        let distributionPrice = this.pricingData[baseAreaType][deliveryType][quantityTier];
                        if (isExtended) {
                            distributionPrice += 8;
                        }
                        
                        const areaTotal = (distributionPrice * quantity / 1000);
                        this.multiAreas[areaIndex].price = areaTotal;
                        
                        document.getElementById(`price_${areaId}`).textContent = `¬£${areaTotal.toFixed(2)}`;
                    } else {
                        this.multiAreas[areaIndex].price = 0;
                        document.getElementById(`price_${areaId}`).textContent = `¬£0.00`;
                    }
                }
                
                this.updateMultiAreaTotal();
            }

            updateMultiAreaTotal() {
                const totalLeaflets = this.multiAreas.reduce((sum, area) => sum + area.quantity, 0);
                const totalPrice = this.multiAreas.reduce((sum, area) => sum + area.price, 0);
                
                document.getElementById('total-leaflets').textContent = totalLeaflets.toLocaleString();
                document.getElementById('multi-distribution-total').textContent = `¬£${totalPrice.toFixed(2)}`;
                
                const totalSection = document.getElementById('multi-area-total');
                if (totalLeaflets > 0) {
                    totalSection.style.display = 'block';
                } else {
                    totalSection.style.display = 'none';
                }
                
                if (this.isMultiArea) {
                    this.calculateMultiAreaPrice(totalPrice, totalLeaflets);
                }
            }

            calculateMultiAreaPrice(distributionTotal, totalQuantity) {
                // Calculate design cost
                let designCost = 0;
                const includeSourceFiles = document.getElementById('source-files').checked;
                if (this.currentDesign === 'single') designCost = 50;
                if (this.currentDesign === 'double') designCost = 75;
                if (this.currentDesign === 'bifold') designCost = 90;
                if (includeSourceFiles && this.currentDesign !== 'none') designCost += 25;

                // Calculate printing cost using total quantity
                let printingCost = 0;
                const includePrinting = document.getElementById('include-printing').checked;
                let printingComplete = this.isPrintingComplete();
                
                if (includePrinting && printingComplete && totalQuantity > 0) {
                    const paperSize = document.getElementById('paper-size').value;
                    const paperStock = document.getElementById('paper-stock').value;
                    const doubleSided = document.getElementById('print-sides').value === 'double';
                    printingCost = this.getPrintingPrice(totalQuantity, paperSize, paperStock, doubleSided);
                }

                // Show/hide printing incomplete warning
                const incompleteWarning = document.getElementById('printing-incomplete');
                if (includePrinting && !printingComplete) {
                    incompleteWarning.style.display = 'block';
                } else {
                    incompleteWarning.style.display = 'none';
                }

                // Apply discounts
                const newCustomer = document.getElementById('new-customer').checked;
                const annualContract = document.getElementById('annual-contract').checked;
                
                let discountAmount = 0;
                let discountPercent = 0;
                let discountLabel = '';

                if (newCustomer && annualContract) {
                    discountPercent = 25;
                    discountLabel = '25%';
                } else if (newCustomer) {
                    discountPercent = 15;
                    discountLabel = '15%';
                } else if (annualContract) {
                    discountPercent = 12;
                    discountLabel = '12%';
                }

                if (discountPercent > 0) {
                    discountAmount = distributionTotal * (discountPercent / 100);
                }

                const discountedDistribution = distributionTotal - discountAmount;
                const finalTotal = discountedDistribution + designCost + printingCost;
                const totalWithVAT = finalTotal * 1.2;

                this.checkDesignPrintMismatch();
                this.updateCombinedDiscountDisplay();
                this.updateBreakdownDisplay(distributionTotal, designCost, printingCost, printingComplete, discountAmount, discountLabel, finalTotal, totalWithVAT, totalQuantity);
            }

            updateAreaIndicator(areaType) {
                const indicator = document.getElementById('area-indicator');
                if (!areaType) {
                    indicator.innerHTML = '';
                    return;
                }

                let className, text;
                switch(areaType) {
                    case 'standard':
                        className = 'area-standard';
                        text = 'Standard Area';
                        break;
                    case 'premium':
                        className = 'area-premium';
                        text = 'Premium Area';
                        break;
                    case 'standard-extended':
                        className = 'area-extended';
                        text = 'Standard Area + ¬£8 Extended Charge';
                        break;
                    case 'premium-extended':
                        className = 'area-extended';
                        text = 'Premium Area + ¬£8 Extended Charge';
                        break;
                }
                indicator.innerHTML = `<div class="area-indicator ${className}">${text}</div>`;
            }

            updateBreakdownDisplay(distributionTotal, designCost, printingCost, printingComplete, discountAmount, discountLabel, finalTotal, totalWithVAT, totalQuantity = null) {
                // Get total quantity for per-leaflet calculation
                let quantity = totalQuantity;
                if (!quantity) {
                    if (this.isMultiArea) {
                        quantity = this.multiAreas.reduce((sum, area) => sum + area.quantity, 0);
                    } else {
                        quantity = this.validateQuantity(document.getElementById('quantity').value, false);
                    }
                }

                // Reset breakdown label to default
                document.querySelector('#distribution-cost').closest('.breakdown-item').querySelector('.breakdown-label').textContent = 'Distribution';

                document.getElementById('distribution-cost').textContent = `¬£${distributionTotal.toFixed(2)}`;
                
                // Design breakdown
                const designBreakdown = document.getElementById('design-breakdown');
                if (designCost > 0) {
                    designBreakdown.style.display = 'flex';
                    document.getElementById('design-cost').textContent = `¬£${designCost.toFixed(2)}`;
                } else {
                    designBreakdown.style.display = 'none';
                }

                // Printing breakdown
                const printingBreakdown = document.getElementById('printing-breakdown');
                if (printingCost > 0 && printingComplete) {
                    printingBreakdown.style.display = 'flex';
                    document.getElementById('printing-cost').textContent = `¬£${printingCost.toFixed(2)}`;
                } else {
                    printingBreakdown.style.display = 'none';
                }

                // Discount breakdown
                const discountBreakdown = document.getElementById('discount-breakdown');
                if (discountAmount > 0) {
                    discountBreakdown.style.display = 'flex';
                    document.getElementById('discount-amount').textContent = `-¬£${discountAmount.toFixed(2)}`;
                    document.getElementById('discount-badge').textContent = discountLabel;
                } else {
                    discountBreakdown.style.display = 'none';
                }

                // Totals
                document.getElementById('total-ex-vat').textContent = `¬£${finalTotal.toFixed(2)}`;
                document.getElementById('quote-total').textContent = `¬£${finalTotal.toFixed(2)}`;
                document.getElementById('quote-vat').textContent = `¬£${totalWithVAT.toFixed(2)} inc. VAT`;
                
                // Per-leaflet cost
                const perLeaflet = quantity > 0 ? finalTotal / quantity : 0;
                document.getElementById('per-leaflet').textContent = `¬£${perLeaflet.toFixed(3)} per leaflet`;
            }

            calculatePrice() {
                if (this.isCalculating) return;
                this.isCalculating = true;

                // Skip calculation if in multi-area mode
                if (this.isMultiArea) {
                    this.updateMultiAreaTotal();
                    this.isCalculating = false;
                    return;
                }
                
                // Get and validate quantity
                const quantityInput = document.getElementById('quantity');
                const quantity = this.validateQuantity(quantityInput.value);
                quantityInput.value = quantity;
                
                // Check for special offer conditions FIRST
                const isSpecialOfferConditions = quantity === 5000 && 
                    this.currentDesign === 'double' && 
                    document.getElementById('include-printing').checked && 
                    document.getElementById('paper-size').value === 'A5' &&
                    document.getElementById('print-sides').value === 'double' &&
                    this.isSpecialOffer;

                if (isSpecialOfferConditions) {
                    // Apply special offer pricing directly
                    const specialOfferPrice = 200;
                    const regularPrice = 438;
                    const savingsAmount = regularPrice - specialOfferPrice;
                    const savingsPercent = Math.round((savingsAmount / regularPrice) * 100);
                    const specialOfferWithVAT = specialOfferPrice * 1.2;
                    const perLeaflet = specialOfferPrice / quantity;

                    // Update all displays with special pricing
                    document.getElementById('distribution-cost').innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <span style="text-decoration: line-through; opacity: 0.6; font-size: 0.85rem;">¬£${regularPrice.toFixed(2)}</span>
                            <span>¬£${specialOfferPrice.toFixed(2)}</span>
                            <span style="color: #10b981; font-size: 0.8rem; font-weight: 700;">SAVE ¬£${savingsAmount} (${savingsPercent}%)</span>
                        </div>
                    `;
                    
                    // Hide individual breakdowns
                    document.getElementById('design-breakdown').style.display = 'none';
                    document.getElementById('printing-breakdown').style.display = 'none';
                    document.getElementById('discount-breakdown').style.display = 'none';
                    
                    // Update breakdown label
                    document.querySelector('#distribution-cost').closest('.breakdown-item').querySelector('.breakdown-label').textContent = 'Launch Special Package';
                    
                    // Update totals
                    document.getElementById('total-ex-vat').textContent = `¬£${specialOfferPrice.toFixed(2)}`;
                    document.getElementById('quote-total').textContent = `¬£${specialOfferPrice.toFixed(2)}`;
                    document.getElementById('quote-vat').textContent = `¬£${specialOfferWithVAT.toFixed(2)} inc. VAT`;
                    document.getElementById('per-leaflet').textContent = `¬£${perLeaflet.toFixed(3)} per leaflet`;
                    
                    this.isCalculating = false;
                    return;
                }

                // Regular pricing calculation
                const deliveryType = document.getElementById('delivery-type').value;
                const includePrinting = document.getElementById('include-printing').checked;
                const newCustomer = document.getElementById('new-customer').checked;
                const annualContract = document.getElementById('annual-contract').checked;
                const includeSourceFiles = document.getElementById('source-files').checked;

                const areaType = this.getAreaType(this.selectedArea);
                this.updateAreaIndicator(areaType);

                // Calculate distribution cost
                const isExtended = areaType && areaType.includes('extended');
                const baseAreaType = areaType ? areaType.replace('-extended', '') : 'standard';
                const quantityTier = this.getQuantityTier(quantity);

                let distributionPrice = this.pricingData[baseAreaType][deliveryType][quantityTier];
                if (isExtended) {
                    distributionPrice += 8;
                }

                const distributionTotal = (distributionPrice * quantity / 1000);

                // Calculate design cost
                let designCost = 0;
                if (this.currentDesign === 'single') designCost = 50;
                if (this.currentDesign === 'double') designCost = 75;
                if (this.currentDesign === 'bifold') designCost = 90;
                if (includeSourceFiles && this.currentDesign !== 'none') designCost += 25;

                // Calculate printing cost
                let printingCost = 0;
                let printingComplete = this.isPrintingComplete();
                
                if (includePrinting && printingComplete) {
                    const paperSize = document.getElementById('paper-size').value;
                    const paperStock = document.getElementById('paper-stock').value;
                    const doubleSided = document.getElementById('print-sides').value === 'double';
                    printingCost = this.getPrintingPrice(quantity, paperSize, paperStock, doubleSided);
                }

                // Show/hide printing incomplete warning
                const incompleteWarning = document.getElementById('printing-incomplete');
                if (includePrinting && !printingComplete) {
                    incompleteWarning.style.display = 'block';
                } else {
                    incompleteWarning.style.display = 'none';
                }

                this.checkDesignPrintMismatch();

                // Apply discounts (ONLY to distribution)
                let discountAmount = 0;
                let discountPercent = 0;
                let discountLabel = '';

                if (newCustomer && annualContract) {
                    discountPercent = 25;
                    discountLabel = '25%';
                } else if (newCustomer) {
                    discountPercent = 15;
                    discountLabel = '15%';
                } else if (annualContract) {
                    discountPercent = 12;
                    discountLabel = '12%';
                }

                if (discountPercent > 0) {
                    discountAmount = distributionTotal * (discountPercent / 100);
                }

                const discountedDistribution = distributionTotal - discountAmount;
                const finalTotal = discountedDistribution + designCost + printingCost;
                const totalWithVAT = finalTotal * 1.2;

                this.updateCombinedDiscountDisplay();
                this.updateBreakdownDisplay(distributionTotal, designCost, printingCost, printingComplete, discountAmount, discountLabel, finalTotal, totalWithVAT, quantity);
                
                this.isCalculating = false;
            }

            // Enhanced quote saving functionality
            saveQuote() {
                try {
                    let quantity, deliveryType, selectedAreaText, totalCost, totalWithVAT;
                    
                    if (this.isMultiArea) {
                        const totalQuantity = this.multiAreas.reduce((sum, area) => sum + area.quantity, 0);
                        quantity = totalQuantity.toLocaleString();
                        deliveryType = document.getElementById('multi-delivery-type').value === 'standard' ? 'Standard Delivery' : 'Solus Delivery';
                        selectedAreaText = this.multiAreas.map(area => `${area.area} (${area.quantity.toLocaleString()})`).join(', ');
                    } else {
                        const quantityValue = this.validateQuantity(document.getElementById('quantity').value, false);
                        quantity = quantityValue.toLocaleString();
                        deliveryType = document.getElementById('delivery-type').value === 'standard' ? 'Standard Delivery' : 'Solus Delivery';
                        selectedAreaText = this.selectedArea;
                    }
                    
                    totalCost = document.getElementById('quote-total').textContent;
                    totalWithVAT = document.getElementById('quote-vat').textContent;
                    
                    let designInfo = 'None';
                    if (this.currentDesign === 'single') designInfo = 'Single-sided design';
                    if (this.currentDesign === 'double') designInfo = 'Double-sided design';
                    if (this.currentDesign === 'bifold') designInfo = 'Bi-fold design';
                    if (document.getElementById('source-files').checked && this.currentDesign !== 'none') {
                        designInfo += ' + source files';
                    }
                    
                    let printingInfo = 'No';
                    if (document.getElementById('include-printing').checked) {
                        const paperSize = document.getElementById('paper-size').value || 'Not selected';
                        const paperStock = document.getElementById('paper-stock').value || 'Not selected';
                        const paperFinish = document.getElementById('paper-finish').value || 'Not selected';
                        const printSides = document.getElementById('print-sides').value || 'Not selected';
                        printingInfo = `Yes - ${paperSize}, ${paperStock}, ${paperFinish}, ${printSides}`;
                    }
                    
                    let discountInfo = 'None';
                    const newCustomer = document.getElementById('new-customer').checked;
                    const annualContract = document.getElementById('annual-contract').checked;
                    if (newCustomer && annualContract) {
                        discountInfo = 'Combined Discount (25%)';
                    } else if (newCustomer) {
                        discountInfo = 'New Customer (15%)';
                    } else if (annualContract) {
                        discountInfo = 'Annual Contract (12%)';
                    }
                    
                    const now = new Date();
                    const quoteRef = `PDQ-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                    
                    const quoteText = `PDQ Leaflets Quote - ${quoteRef}
                    
üìç Delivery Areas: ${selectedAreaText}
üì¶ Total Quantity: ${quantity}
üöö Delivery Type: ${deliveryType}
üé® Design: ${designInfo}
üñ®Ô∏è Printing: ${printingInfo}
üí∞ Discounts: ${discountInfo}

üí∑ Total: ${totalCost} (${totalWithVAT})

Generated: ${now.toLocaleString()}
Contact: 01752 546 123
Email: info@pdqleaflets.co.uk
Web: pdqleaflets.co.uk`;

                    // Copy to clipboard
                    navigator.clipboard.writeText(quoteText).then(() => {
                        this.showSavedNotification();
                    }).catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = quoteText;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showSavedNotification();
                    });
                    
                } catch (error) {
                    console.error('Error saving quote:', error);
                    alert('Failed to save quote. Please try again or call us at 01752 546 123.');
                }
            }

            showSavedNotification() {
                const popup = document.getElementById('quote-saved-popup');
                popup.classList.add('show');
                
                setTimeout(() => {
                    popup.classList.remove('show');
                }, 3000);
            }

            // Enhanced quote request with better error handling
            requestQuote() {
                try {
                    const btn = document.getElementById('request-quote-btn');
                    btn.classList.add('loading');
                    btn.disabled = true;

                    let quantity, deliveryType, selectedAreaText;
                    
                    if (this.isMultiArea) {
                        const totalQuantity = this.multiAreas.reduce((sum, area) => sum + area.quantity, 0);
                        quantity = totalQuantity.toLocaleString();
                        deliveryType = document.getElementById('multi-delivery-type').value === 'standard' ? 'Standard Delivery' : 'Solus Delivery';
                        selectedAreaText = this.multiAreas.map(area => `${area.area} (${area.quantity.toLocaleString()})`).join(', ');
                    } else {
                        const quantityValue = this.validateQuantity(document.getElementById('quantity').value, false);
                        quantity = quantityValue.toLocaleString();
                        deliveryType = document.getElementById('delivery-type').value === 'standard' ? 'Standard Delivery' : 'Solus Delivery';
                        selectedAreaText = this.selectedArea;
                    }
                    
                    const total = document.getElementById('quote-total').textContent;
                    const totalWithVAT = document.getElementById('quote-vat').textContent;
                    
                    let designInfo = 'None';
                    if (this.currentDesign === 'single') designInfo = 'Single-sided design';
                    if (this.currentDesign === 'double') designInfo = 'Double-sided design';
                    if (this.currentDesign === 'bifold') designInfo = 'Bi-fold design';
                    if (document.getElementById('source-files').checked && this.currentDesign !== 'none') {
                        designInfo += ' + source files';
                    }
                    
                    let printingInfo = 'No';
                    if (document.getElementById('include-printing').checked) {
                        const paperSize = document.getElementById('paper-size').value || 'Not selected';
                        const paperStock = document.getElementById('paper-stock').value || 'Not selected';
                        const paperFinish = document.getElementById('paper-finish').value || 'Not selected';
                        const printSides = document.getElementById('print-sides').value || 'Not selected';
                        printingInfo = `Yes - ${paperSize}, ${paperStock}, ${paperFinish}, ${printSides}`;
                    }
                    
                    let discountInfo = 'None';
                    const newCustomer = document.getElementById('new-customer').checked;
                    const annualContract = document.getElementById('annual-contract').checked;
                    if (newCustomer && annualContract) {
                        discountInfo = 'Combined Discount (25%)';
                    } else if (newCustomer) {
                        discountInfo = 'New Customer (15%)';
                    } else if (annualContract) {
                        discountInfo = 'Annual Contract (12%)';
                    }
                    
                    const now = new Date();
                    const quoteRef = `PDQ-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                    
                    const googleFormURL = 'https://docs.google.com/forms/d/e/1FAIpQLSdP7_sx3AbqWfvEXTyUPoWDa2euvnxvu5-GNHs7u7R0xKuu1Q/viewform';
                    
                    const formParams = new URLSearchParams({
                        'entry.470958436': selectedAreaText,
                        'entry.579439748': quantity,
                        'entry.2016134755': deliveryType,
                        'entry.1152225761': designInfo,
                        'entry.1643154630': printingInfo,
                        'entry.1651987508': `${total} (${totalWithVAT})`,
                        'entry.621454976': quoteRef,
                    });
                    
                    const finalURL = `${googleFormURL}?${formParams.toString()}`;
                    const newWindow = window.open(finalURL, '_blank');
                    
                    // Check if popup was blocked
                    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                        throw new Error('Popup blocked');
                    }
                    
                    btn.textContent = '‚úÖ Opening quote form...';
                    btn.style.background = '#10b981';
                    
                    setTimeout(() => {
                        btn.textContent = 'Request To Book';
                        btn.style.background = '#2563eb';
                        btn.classList.remove('loading');
                        btn.disabled = false;
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error requesting quote:', error);
                    
                    const btn = document.getElementById('request-quote-btn');
                    btn.textContent = '‚ùå Error - Please call us';
                    btn.style.background = '#ef4444';
                    
                    setTimeout(() => {
                        btn.textContent = 'Request To Book';
                        btn.style.background = '#2563eb';
                        btn.classList.remove('loading');
                        btn.disabled = false;
                    }, 5000);
                    
                    alert('Unable to open quote form. Please call us directly at 01752 546 123 or save your quote and email it to us.');
                }
            }

            // Enhanced event listener management to prevent memory leaks
            addEventListener(element, event, handler) {
                if (element && typeof handler === 'function') {
                    element.addEventListener(event, handler);
                    
                    const key = element.id + '_' + event;
                    if (!this.eventListeners.has(key)) {
                        this.eventListeners.set(key, []);
                    }
                    this.eventListeners.get(key).push({ element, event, handler });
                }
            }

            removeEventListener(element, event) {
                const key = element.id + '_' + event;
                const listeners = this.eventListeners.get(key);
                if (listeners) {
                    listeners.forEach(({ element, event, handler }) => {
                        element.removeEventListener(event, handler);
                    });
                    this.eventListeners.delete(key);
                }
            }

            // Clean up all event listeners
            cleanup() {
                this.eventListeners.forEach((listeners) => {
                    listeners.forEach(({ element, event, handler }) => {
                        element.removeEventListener(event, handler);
                    });
                });
                this.eventListeners.clear();
            }

            initializeEventListeners() {
                // Form change listeners with proper context binding
                this.addEventListener(document.getElementById('quantity'), 'input', () => this.debouncedCalculate());
                this.addEventListener(document.getElementById('quantity'), 'blur', () => this.debouncedCalculate());
                this.addEventListener(document.getElementById('delivery-type'), 'change', () => this.debouncedCalculate());
                this.addEventListener(document.getElementById('extended-areas'), 'change', () => this.setExtendedArea());
                this.addEventListener(document.getElementById('multi-area-mode'), 'change', () => this.toggleMultiArea());
                this.addEventListener(document.getElementById('multi-delivery-type'), 'change', () => {
                    this.multiAreas.forEach(area => this.updateMultiArea(area.id));
                });
                this.addEventListener(document.getElementById('include-printing'), 'change', () => this.togglePrintingOptions());
                
                // Printing option listeners
                ['paper-size', 'paper-stock', 'paper-finish', 'print-sides'].forEach(id => {
                    this.addEventListener(document.getElementById(id), 'change', () => {
                        this.checkDesignPrintMismatch();
                        this.debouncedCalculate();
                    });
                });
                
                // Discount listeners
                this.addEventListener(document.getElementById('new-customer'), 'change', () => {
                    this.updateCombinedDiscountDisplay();
                    this.debouncedCalculate();
                });
                this.addEventListener(document.getElementById('annual-contract'), 'change', () => {
                    this.updateCombinedDiscountDisplay();
                    this.debouncedCalculate();
                });
                this.addEventListener(document.getElementById('source-files'), 'change', () => this.debouncedCalculate());
            }

            setInitialState() {
                document.querySelector('[onclick="setPostcode(\'PL2\')"]').classList.add('selected');
                this.selectedArea = 'PL2';
                
                const quantityInput = document.getElementById('quantity');
                if (!quantityInput.value) quantityInput.value = '1000';
            }
        }

        // Global functions for onclick handlers (maintain backward compatibility)
        let calculator;

        function setPostcode(areaCode) {
            calculator.setPostcode(areaCode);
        }

        function setExtendedArea() {
            calculator.setExtendedArea();
        }

        function selectDesign(type) {
            calculator.selectDesign(type);
        }

        function setCheapestOption() {
            calculator.setCheapestOption();
        }

        function applySpecialOffer() {
            calculator.applySpecialOffer();
        }

        function togglePrintingOptions() {
            calculator.togglePrintingOptions();
        }

        function addArea() {
            calculator.addArea();
        }

        function requestQuote() {
            calculator.requestQuote();
        }

        function saveQuote() {
            calculator.saveQuote();
        }

        // Initialize calculator when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                calculator = new QuoteCalculator();
                console.log('Enhanced PDQ Calculator loaded successfully');
            } catch (error) {
                console.error('Error initializing Enhanced PDQ Calculator:', error);
                // Fallback to basic functionality if enhanced version fails
                alert('Calculator is running in basic mode. Some features may be limited. Please refresh the page or contact support.');
            }
        });

        // Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', function() {
            if (calculator && typeof calculator.cleanup === 'function') {
                calculator.cleanup();
            }
        });
    </script>
</body>
</html>
